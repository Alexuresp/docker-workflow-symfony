<?xml version="1.0"?>
<project name="Docker Symfony App" default="init" basedir=".">
    <property name="composer.path" value="/usr/local/bin/composer" />
    <property name="symfony.console" value="bin/console" />
    <property name="symfony.env" value="dev" />
    <property name="symfony.var" value="${project.basedir}/var" />

    <target name="init" depends="composer-install,app-init,app-update">
        <echo message="${phing.project.name} Init - OK" />
    </target>

    <target name="deploy" depends="app-init">
        <echo message="${phing.project.name} Deploy - OK" />
    </target>

    <target name="composer-install">
        <composer composer="${composer.path}" command="config">
            <arg value="-g" />
            <arg value="cache-dir" />
            <arg value="/srv/var/cache/composer" />
        </composer>
        <composer composer="${composer.path}" command="install" />
        <exec executable="sync-vendor" passthru="true" />

        <echo message="${phing.project.name} ComposerInstall - OK" />
    </target>

    <target name="app-init">
        <delete dir="${symfony.var}/cache/${symfony.env}" />
        <SymfonyConsole console="${symfony.console}" command="cache:warmup" checkReturn="true">
            <arg name="env" value="${symfony.env}" />
        </SymfonyConsole>

        <SymfonyConsole console="${symfony.console}" command="doctrine:schema:update" checkReturn="true">
            <arg name="env" value="${symfony.env}" />
            <arg value="--force" />
            <arg value="--no-interaction" />
        </SymfonyConsole>

        <SymfonyConsole console="${symfony.console}" command="assets:install" checkReturn="true">
            <arg name="env" value="${symfony.env}" />
            <arg value="--symlink" />
            <arg value="web" />
        </SymfonyConsole>

        <echo message="${phing.project.name} AppInit - OK" />
    </target>

    <target name="app-update" depends="db-migrate">
        <echo message="${phing.project.name} AppUpdate - OK" />
    </target>

    <target name="db-migrate">
        <SymfonyConsole console="${symfony.console}" command="doctrine:migrations:status" checkReturn="true">
            <arg name="env" value="${symfony.env}" />
        </SymfonyConsole>

        <SymfonyConsole console="${symfony.console}" command="doctrine:migrations:migrate" checkReturn="true">
            <arg name="env" value="${symfony.env}" />
            <arg value="--no-interaction" />
            <arg value="--allow-no-migration" />
        </SymfonyConsole>

        <echo message="${phing.project.name} DbMigrate - OK" />
    </target>
</project>
