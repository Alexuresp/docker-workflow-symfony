<?xml version="1.0"?>
<project name="Docker Symfony App" default="init" basedir=".">
    <property name="composer.path" value="/usr/local/bin/composer" />
    <property name="symfony.console" value="bin/console" />
    <property name="symfony.env" value="dev" />
    <property name="symfony.var" value="${project.basedir}/var" />

    <target name="init" depends="composer-install,image-prepare,app-deploy">
        <echo message="${phing.project.name} Init - OK" />
    </target>

    <target name="composer-install">
        <composer composer="${composer.path}" command="config">
            <arg value="-g" />
            <arg value="cache-dir" />
            <arg value="/srv/var/cache/composer" />
        </composer>
        <composer composer="${composer.path}" command="install">
            <arg value="--no-scripts" />
        </composer>
        <exec executable="sync-vendor" passthru="true" />

        <echo message="${phing.project.name} ComposerInstall - OK" />
    </target>

    <target name="image-prepare">
        <!-- do something before (and without) symfony console -->
        <echo message="${phing.project.name} AppInit - OK" />
    </target>

    <target name="app-deploy">
        <composer composer="${composer.path}" command="run-script">
            <arg value="post-install-cmd" />
        </composer>

        <SymfonyConsole console="${symfony.console}" command="cache:clear" checkReturn="true">
            <arg name="env" value="${symfony.env}" />
            <arg value="--no-warmup" />
        </SymfonyConsole>

        <SymfonyConsole console="${symfony.console}" command="cache:warmup" checkReturn="true">
            <arg name="env" value="${symfony.env}" />
        </SymfonyConsole>

        <SymfonyConsole console="${symfony.console}" command="assets:install" checkReturn="true">
            <arg name="env" value="${symfony.env}" />
            <arg value="--symlink" />
            <arg value="web" />
        </SymfonyConsole>

        <SymfonyConsole console="${symfony.console}" command="doctrine:schema:update" checkReturn="true">
            <arg name="env" value="${symfony.env}" />
            <arg value="--force" />
            <arg value="--no-interaction" />
        </SymfonyConsole>

        <SymfonyConsole console="${symfony.console}" command="doctrine:migrations:status" checkReturn="true">
            <arg name="env" value="${symfony.env}" />
        </SymfonyConsole>

        <SymfonyConsole console="${symfony.console}" command="doctrine:migrations:migrate" checkReturn="true">
            <arg name="env" value="${symfony.env}" />
            <arg value="--no-interaction" />
            <arg value="--allow-no-migration" />
        </SymfonyConsole>

        <echo message="${phing.project.name} AppUpdate - OK" />
    </target>
</project>
